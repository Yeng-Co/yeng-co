  <!DOCTYPE html>
<html class="jrboxfutp idc0_350">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>墓場</title>
  <link rel="icon" type="image/png" href="icon.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hina+Mincho&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+1p&display=swap');

    body {
      background-color: white;
      font-size: 90%;
      font-family: 'M PLUS 1p', sans-serif;
    }
    .header {
      background-color: white;
      font-size: 30px;
      color: #000;
      text-align: left;
    }
    .nav-menu {
      overflow: hidden;
      background-color: black;
    }
    .nav-menu a {
      font-size: 15px;
      float: left;
      display: block;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }
    .nav-menu b {
      font-size: 15px;
      float: left;
      display: white;
      color: black;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      background-color: white;
    }
    .nav-menu a:hover {
      background-color: white;
      color: black;
      text-decoration: none;
    }
    .nav-menu .note {
      font-size: 15px;
      float: left;
      display: #43cbb5;
      color: #43cbb5;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      background-color: black;
    }
    .nav-menu .note:hover {
      background-color: white;
      color: #43cbb5;
      text-decoration: underline;
    }
    .nav-menu .git {
      font-size: 15px;
      float: left;
      display: #f34e29;
      color: #f34e29;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      background-color: black;
    }
    .nav-menu .git:hover {
      background-color: white;
      color: #f34e29;
      text-decoration: underline;
    }
    .nav-menu .music {
      font-size: 15px;
      float: left;
      color: #fa2d48;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      background-color: black;
    }
    .nav-menu .music:hover {
      background-color: white;
      color: #fa2d48;
      text-decoration: underline;
    }
    li {
      font-size: 22px;
      color: black;
    }
    h1 {
      font-family: "Hina Mincho", serif;
    }
    hr {
      margin-top: 6px;
      margin-bottom: 6px;
    }
    h2 {
      font-family: "Hina Mincho", serif;
      font-size: 30px;
      color: black;
      text-align: center;
    }
    h3 {
      font-size: 24px;
      color: black;
      border: 4px solid black;
      border-radius: 20px;
      padding: 5px;
      margin: 10px 0;
      text-align: center;
      font-weight: normal;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      background-color: white;
    }
    .scrollable-list {
      width: 80%;
      height: 500px;
      overflow-y: scroll;
      background-color: #dddddd;
      padding: 15px;
      border: 4px solid black; 
      border-radius: 20px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    crollable-list::-webkit-scrollbar {
      display: none;
    }
    ol {
      padding-left: 20px;
      margin: 25px;
      margin-top: 5px;
      margin-bottom: 5px;
      text-align: left;
    }
    .button {
      display: inline-block;
      padding: 7px 20px; 
      border: 3px solid #000000;
      border-radius: 40px;
      font-family: "M PLUS 1p", sans-serif;
      color: black;
      background-color: white;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      font-size: 18px; 
      font-weight: 600;
      margin: auto;
      margin-top: 10px;
      margin-bottom: 10px;
      display: block;
      width: fit-content;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>墓場</h1>
    <hr size="10px" color="black">
  </div>

  <div class="nav-menu">
    <a href="index.html">ホーム</a>
    <a href="profile.html">プロフィール</a>
    <b href="note.html">読書記録</b>
    <a href="clock.html">時計</a>
    <a href="banner.html">バナー</a>
    <a class="music" href="https://music.apple.com/jp/playlist/%E8%89%AF%E3%81%84%E9%9F%B3%E6%A5%BD/pl.u-b3b8RMeSKrk07Pk" target="_blank" rel="noopener noreferrer">プレイリスト</a>
    <a class="note" href="https://note.com/uyuni_arc/" target="_blank" rel="noopener noreferrer">note</a>
    <a class="git" href="https://github.com/Yeng-Co" target="_blank" rel="noopener noreferrer">GitHub</a>
  </div>
  <hr size="10px" color="black">
  <h2>読書記録</h2>
  <center>
    <a href="book_2024.html">読書記録_2024</a>
  </center>
  <h3>読書記録(2025/01/01~)</h3>
  <center>
    <div class="scrollable-list">
      <ol id="myList" class="hidden" reversed="reversed">
        <li data-isbn="9784781617411">木澤佐登志『ダークウェブ・アンダーグラウンド：社会秩序を逸脱するネット暗部の住人たち』</li>
        <li data-isbn="9784309209203">ジャミル・ジャン・コチャイ『きみはメタルギアソリッドV：ファントムペインをプレイする』</li>
        <li data-isbn="9784480083470">ロラン・バルト『エッフェル塔』</li>
        <li data-isbn="9784150124694">デュナ『カウンターウェイト』</li>
        <li data-isbn="9784409031094">グレアム・ハーマン『思弁的実在論入門』</li>
        <li data-isbn="9784003104668">志賀直哉・高橋英夫編『志賀直哉随筆集』</li>
        <li data-isbn="9784863856011">中村達『私が諸島である：カリブ海思想入門』</li>
        <li data-isbn="9784150123550">ニール・スティーヴンスン『スノウ・クラッシュ〔新版〕下』</li>
        <li data-isbn="9784150123543">ニール・スティーヴンスン『スノウ・クラッシュ〔新版〕上』</li>
        <li data-isbn="9784065160145">木澤佐登志『ニック・ランドと新反動主義：現代世界を覆う“ダーク”な思想』</li>
        <li data-isbn="9784022520395">鈴木 結生『ゲーテはすべてを言った』</li>
        <li data-isbn="9784065197035">ニック・ランド『暗黒の啓蒙書』</li>
        <li data-isbn="9784150124311">デイヴィッド・ウェリントン『妄想感染体 下』</li>
        <li data-isbn="9784150124304">デイヴィッド・ウェリントン『妄想感染体 上』</li>
        <li data-isbn="9784314011662">フェルナンド・バエス『書物の破壊の世界史：シュメールの粘土板からデジタル時代まで』</li>
        <li data-isbn="9784336076809">ヘルベルト・ローゼンドルファー『廃墟建築家』</li>
        <li data-isbn="9784065376225">佐藤究『トライロバレット』</li>
        <li data-isbn="9784480512840">ウィトゲンシュタイン『色彩について』</li>
        <li data-isbn="9784150118549">チャイナ・ミエヴィル『ペルディード・ストリート・ステーション 下』</li>
        <li data-isbn="9784150118532">チャイナ・ミエヴィル『ペルディード・ストリート・ステーション 上』</li>
        <li data-isbn="9784480089366">ロラン・バルト『映像の修辞学』</li>
        <li data-isbn="9784150313180">カルロ・ゼン『ヤキトリ2 Broken Toy Soldier』</li>
        <li data-isbn="9784150312800">カルロ・ゼン『ヤキトリ1 一銭五厘の軌道降下』</li>
        <li data-isbn="9784153400269">小宮山功一朗・小泉悠『サイバースペースの地政学』</li>
        <li data-isbn="9784150306342">神林長平『魂の駆動体』</li>
      </ol>
    </div>
    <div id="result" style="font-size: 20px; margin-top: 10px;"></div>
  </center>
  <button class="button" onclick="download()">現在の読書記録をダウンロード(CSV)</button>

<script>
function convertPubdate(pubdate) {
  const digits = pubdate.replace(/\D/g, '');
  if (digits.length >= 6) {
    return digits.substring(0, 4) + "-" + digits.substring(4, 6);
  } else if (digits.length === 4) {
    return digits + "-01";
  } else {
    return pubdate; 
  }
}

async function fetchBookData(item) {
  const isbn = item.getAttribute('data-isbn');
  if (!isbn) {
    item.dataset.confirmed = "true";
    return;
  }
  try {
    const response = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
    if (response.ok) {
      const data = await response.json();
      if (Array.isArray(data) && data.length > 0 && data[0] !== null) {
        const summary = data[0].summary;
        let publisher = summary.publisher;
        if (!publisher || publisher.trim() === "") {
          publisher = summary.series;
        }
        if (publisher && publisher.trim() !== "") {
          item.dataset.publisher = publisher;
        } else {
          item.dataset.publisher = "null";
        }
        let pubdate = summary.pubdate;
        if (pubdate && pubdate.trim() !== "") {
          pubdate = convertPubdate(pubdate);
          item.dataset.pubdate = pubdate;
        } else {
          item.dataset.pubdate = "null";
        }
        item.dataset.confirmed = "true"; 
      } else {
        item.dataset.publisher = "null";
        item.dataset.pubdate = "null";
        item.dataset.confirmed = "true";
      }
    }
  } catch (error) {
    console.error("書籍のデータ取得エラー:", error);
  }
}

async function fetchAllBookData() {
  const listItems = document.querySelectorAll('#myList > li');
  let needRetry = false;
  const maxRetries = 4;
  const promises = Array.from(listItems).map(async (item) => {
    const isbn = item.getAttribute('data-isbn');
    if (isbn) {
      if (!item.dataset.retryCount) {
        item.dataset.retryCount = "0";
      }
      if (item.dataset.confirmed !== "true") {
        await fetchBookData(item);
        if (item.dataset.confirmed !== "true") {
          let count = parseInt(item.dataset.retryCount, 10);
          count++;
          item.dataset.retryCount = count.toString();
          if (count < maxRetries) {
            needRetry = true;
          } else {
            item.dataset.confirmed = "true";
            if (!item.dataset.publisher) {
              item.dataset.publisher = "null";
            }
            if (!item.dataset.pubdate) {
              item.dataset.pubdate = "null";
            }
          }
        }
      }
    }
  });
  await Promise.all(promises);
  if (needRetry) {
    return new Promise(resolve => {
      setTimeout(() => resolve(fetchAllBookData()), 2000);
    });
  } else {
    alert("すべての書籍の情報取得が完了しました");
    return;
  }
}

async function download() {
  await fetchAllBookData();

  const listItems = document.querySelectorAll('#myList > li');
  const csvRows = [];
  csvRows.push(['著者', 'タイトル', 'ISBN', '出版社', '出版日'].join(','));

  for (const item of listItems) {
    const text = item.textContent;
    const isbn = item.getAttribute('data-isbn');
    const match = text.match(/^(.+?)『(.+)』$/);
    if (match) {
      const author = match[1].trim();
      const title = match[2].trim();
      let publisher = isbn ? (item.dataset.publisher || "null") : "null";
      let pubdate = isbn ? (item.dataset.pubdate || "null") : "null";

      const escapeCsvField = (field) => {
        if (field.includes('"')) {
          field = field.replace(/"/g, '""');
        }
        if (field.includes(',') || field.includes('"') || field.includes('\n')) {
          field = `"${field}"`;
        }
        return field;
      };

      csvRows.push([
        escapeCsvField(author),
        escapeCsvField(title),
        escapeCsvField(isbn || ""),
        escapeCsvField(publisher),
        escapeCsvField(pubdate)
      ].join(','));
    }
  }

  const csvString = csvRows.join('\n');
  const bom = '\ufeff';
  const csvWithBom = bom + csvString;
  const blob = new Blob([csvWithBom], { type: 'text/csv; charset=utf-8' });
  const url = URL.createObjectURL(blob);

  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const dateString = `${yyyy}${mm}${dd}`;
  const filename = `bookrecords_${dateString}.csv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

document.addEventListener('DOMContentLoaded', function() {
      const listItems = document.querySelectorAll('#myList > li');
      const count = listItems.length;
      const start = new Date('2025-01-01');
      const today = new Date();
      const diffTime = today - start;
      const days = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
      const average = count / days;
      const resultDiv = document.getElementById('result');
      resultDiv.innerText = 'r/d: ' + average.toFixed(4);
});
</script>


</body>
</html>
</body>
</html>
